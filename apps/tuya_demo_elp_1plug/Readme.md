# demo简介

## 功能介绍

### 1. 开关

​	开关主要分为硬件设备控制和app控制。

+ 硬件设备控制：按键轻触，继电器动作，开关状态导通/断开，上报开关状态；
+ app控制：app下发开关状态，控制继电器状态，开关对应导通/断开；

### 2.倒计时

​	app上设置倒计时时间，控制开关延时触发。

+ 倒计时：app设置延时多长时间，延时时间到了开关导通或断开；

### 3.配网

​	配网模式主要分为：Smartconfig模式和AP热点模式。通过按键长按进入配网模式和配网模式的切换。

+ Smartconfig模式：简称为EZ配网模式，Wi-Fi指示灯250ms闪烁指示状态；
+ AP模式：在EZ配网状态下，按键长按5秒进入AP配网模式，Wi-Fi指示灯1500ms闪烁指示状态；

### 4.上电通道状态

​	app上可以设置设备上电通道状态，主要分为通电、断电和断电记忆三种状态。

+ 通电：断电上电之后，设备开关默认闭合状态。
+ 断电：断电上电之后，设备开关默认断开状态。
+ 断电记忆：断电上电之后，设备开关状态恢复到断电前开关状态。

### 5.定时

​	app上设置开关定时动作，可以设置单次触发和循环触发。循环触发分为：周循环和天循环。

### 6.恢复出厂设置

​	app上操作恢复出厂设置，设备状态恢复到出厂状态。主要是清空用户设备操作的存储。

## 应用架构

+ 头文件
  + tuya_device.h:产品pid、软件版本号信息和设备初始化API的接口；
  + tuya_hard_table.h:硬件相关数据结构和硬件操作相关的API接口；
  + tuya_dp_upload.h:上报数据结构参数和上报数据相关的API接口;
+ 源文件
  + tuya_device.c:soc的应用整体框架，包括正常工作状态、产测模式和app下发控制数据上报等功能；
  + tuya_hard_table.c:硬件部分操作，包括硬件初始化和相关硬件操作逻辑；
  + tuya_dp_upload.c:上报数据相关API的实现，主要包括上报数据结构体数据初始化、不同类型数据上报结构填充接口实现等；

## 编译指令

### 1.编译指令

+ 使用编译指令：./build_app.sh+工程路径名+工程名+版本号，生成正式版本，eg：

  ```C
  ./build_app.sh apps/tuya_elp_1plug_demo tuya_elp_1plug_demo 0.0.1
  ```

### 2.编译过程

+ 进入SDK解压文件夹，使用ls指令查看当前路径下是否有./build_app.sh脚本，有脚本文件进行下一步编译；

+ 使用编译指令，eg:`./build_app.sh apps/tuya_elp_1plug_demo 0.0.1`

+ 编译完成，生成测试产物。测试产物路径：` ./apps/xxx/output/`。xxx指工程名。测试产物以版本号新建文件夹。使用上面编译指令，使用指令`cd ./apps/tuya_elp_1plug_demo/output/`。进入测试产物路径，在该路径下会有1.0.0名称的文件夹，文件夹中有对应的测试产物。

+ demo测试产物文件夹中重要的几个文件如下：

  | 文件名                            | 文件类型 | 备注                                       |
  | --------------------------------- | -------- | ------------------------------------------ |
  | tuya_elp_1plug_demo_QIO_0.0.1.bin | .bin文件 | 生产固件，用于模块flash工作模式为QIO的模组 |
  | tuya_elp_1plug_demo_UA_0.0.1.bin  | .bin文件 | 用户区固件，云模组烧录工具烧录的就是该文件 |
  | tuya_elp_1plug_demo_UG_0.0.1.bin  | .bin文件 | 升级固件，用于OTA升级                      |

## 烧录

 根据云模组烧录流程申请token。

### 硬件测试相关信息

+ 硬件信息

  主要是硬件各个部分的IO口引脚和有效电平 

  | 功能         | I/O引脚 | 有效电平   |
  | ------------ | ------- | ---------- |
  | 按键         | pwm1    | 低电平有效 |
  | 继电器       | pwm0    | 高电平有效 |
  | 继电器指示灯 | pwm2    | 低电平有效 |
  | Wi-Fi指示灯  | pwm3    | 低电平有效 |

+ 其他功能

  | 功能                | 详细内容                                                     |
  | ------------------- | ------------------------------------------------------------ |
  | Wi-Fi上电模式       | GWCM_LOW_POWER_AUTOCFG                                       |
  | Wi-FI状态指示灯显示 | 1. 配网中，ez：Wi-Fi指示灯250ms闪烁，ap：Wi-Fi指示灯1500ms闪烁<br />2. 未联网和联网失败，Wi-Fi指示灯熄灭<br />3. 联网成功，Wi-Fi指示灯点亮 |
  | 通道状态            | 默认为断开，app上可以设置上电通道状态                        |

